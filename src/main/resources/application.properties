# =============================================================================
# Cart Service Configuration (Quarkus)
# =============================================================================

# Application
quarkus.application.name=cart-service
quarkus.application.version=1.0.0

# HTTP Server
quarkus.http.port=8008
quarkus.http.host=0.0.0.0
quarkus.http.cors=true

# Development mode
quarkus.live-reload.instrumentation=true
%dev.quarkus.log.console.enable=true
%dev.quarkus.log.console.format=%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n
%dev.quarkus.log.console.level=DEBUG
%dev.quarkus.log.category."com.xshopai".level=DEBUG

# Logging
quarkus.log.level=INFO
quarkus.log.console.format=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %s%e%n
quarkus.log.console.json=false
%prod.quarkus.log.console.json=true

# File Logging
quarkus.log.file.enable=true
quarkus.log.file.path=logs/cart-service.log
quarkus.log.file.format=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %s%e%n
quarkus.log.file.rotation.max-file-size=10M
quarkus.log.file.rotation.max-backup-index=5
quarkus.log.file.rotation.file-suffix=.yyyy-MM-dd
quarkus.log.file.rotation.rotate-on-boot=true
%prod.quarkus.log.file.json=true

# =============================================================================
# Cart Storage Provider Configuration
# =============================================================================
# Options: auto, dapr, redis
# - auto: Try Dapr first, fall back to Redis (default)
# - dapr: Use Dapr state store (requires Dapr sidecar)
# - redis: Use direct Redis connection
cart.storage.provider=${STORAGE_PROVIDER:auto}

# =============================================================================
# Redis Configuration (used when storage.provider=redis or auto fallback)
# =============================================================================
quarkus.redis.hosts=redis://${REDIS_HOST:localhost}:${REDIS_PORT:6379}
quarkus.redis.timeout=10s
quarkus.redis.max-pool-size=20
quarkus.redis.max-pool-waiting=50

# Dapr Configuration (used when storage.provider=dapr)
dapr.state-store=${DAPR_STATE_STORE:statestore}
dapr.grpc.port=${DAPR_GRPC_PORT:50001}

# =============================================================================
# Service Dependencies
# =============================================================================
# Product service URL for direct HTTP calls (used when Dapr unavailable)
product-service.url=${PRODUCT_SERVICE_URL:http://localhost:8001}

# =============================================================================
# JWT Authentication (HS256 - Symmetric Key)
# =============================================================================
# Cart service validates JWTs for /api/v1/cart/* endpoints (authenticated users)
# Guest endpoints (/api/v1/guest/*) and operational endpoints (/, /health) are public

# JWT Verification Configuration
mp.jwt.verify.issuer=auth-service
mp.jwt.verify.audiences=xshopai-platform

# HS256 symmetric key - loaded from environment variable or Dapr secret store
# In production, JWT_SECRET is injected via environment variable from Azure Key Vault
smallrye.jwt.verify.algorithm=HS256
smallrye.jwt.verify.key.location=${JWT_SECRET:}
mp.jwt.verify.publickey.algorithm=HS256

# Token extraction from Authorization header (Bearer token)
smallrye.jwt.token.header=Authorization
smallrye.jwt.token.schemes=Bearer
smallrye.jwt.always-check-authorization=false

# =============================================================================
# HTTP Security - Path-based Authorization
# =============================================================================
# Protect /api/v1/cart/* (authenticated user cart operations)
# Allow /api/v1/guest/* (guest cart operations - public)
# Allow operational endpoints (/, /health, /health/*, /version, /metrics, /swagger*)

# Enable security
quarkus.http.auth.basic=false
quarkus.http.auth.form.enabled=false

# Public paths (no authentication required)
quarkus.http.auth.permission.public.paths=/,/health,/health/*,/liveness,/readiness,/version,/info,/metrics,/swagger,/swagger-ui,/swagger-ui/*,/q/*
quarkus.http.auth.permission.public.policy=permit

# Guest cart endpoints (public - identified by guestId in path)
quarkus.http.auth.permission.guest.paths=/api/v1/guest/*
quarkus.http.auth.permission.guest.policy=permit

# Authenticated cart endpoints (require valid JWT)
quarkus.http.auth.permission.authenticated.paths=/api/v1/cart,/api/v1/cart/*
quarkus.http.auth.permission.authenticated.policy=authenticated

# OpenAPI/Swagger
quarkus.smallrye-openapi.path=/swagger
quarkus.swagger-ui.always-include=true
quarkus.swagger-ui.path=/swagger-ui
quarkus.swagger-ui.enable=true

# Health
quarkus.smallrye-health.root-path=/health

# Cart Configuration
cart.default-ttl=720h
cart.guest-ttl=72h
cart.max-items=100
cart.cleanup-interval=1h

# Dapr Configuration
dapr.http-port=${DAPR_HTTP_PORT:3500}
dapr.grpc-port=${DAPR_GRPC_PORT:50001}
dapr.app-id=cart-service
dapr.state-store=statestore
dapr.pubsub-name=pubsub
dapr.secret-store=secretstore

# =============================================================================
# Dapr Profile Configuration
# =============================================================================
%dapr.dapr.http-port=3508
%dapr.dapr.grpc-port=50008
%dapr.quarkus.log.category."com.xshopai".level=DEBUG

# =============================================================================
# OpenTelemetry Tracing Configuration (Quarkus)
# =============================================================================
# OTEL_TRACES_EXPORTER controls which exporter to use:
#   - zipkin: Local development with Zipkin (uses OTEL_EXPORTER_ZIPKIN_ENDPOINT)
#   - otlp: OpenTelemetry Collector (uses OTEL_EXPORTER_OTLP_ENDPOINT)
#   - none: Disable tracing (default)
#
# For Azure Application Insights, use the Quarkus Azure extension or OTLP exporter
# pointing to an Azure-compatible collector.
#
# Environment Variables:
#   OTEL_TRACES_EXPORTER=zipkin
#   OTEL_EXPORTER_ZIPKIN_ENDPOINT=http://localhost:9411/api/v2/spans
#   OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318
#   OTEL_SERVICE_NAME=cart-service
# =============================================================================
quarkus.otel.enabled=true
quarkus.otel.service.name=${OTEL_SERVICE_NAME:cart-service}
quarkus.otel.traces.exporter=${OTEL_TRACES_EXPORTER:none}
